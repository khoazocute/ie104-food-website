<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Thanh to√°n ‚Äî Junk Food Shop</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/cart.css">
  <link rel="stylesheet" href="../assets/css/checkout.css">
</head>
<body>
  <div id="header-placeholder"></div>

  <main class="checkout-main">
    <div class="checkout-header">
      <h1>üõí Thanh To√°n ƒê∆°n H√†ng</h1>
      <p>Ho√†n t·∫•t th√¥ng tin ƒë·ªÉ x√°c nh·∫≠n ƒë∆°n h√†ng c·ªßa b·∫°n</p>
    </div>

    <section class="checkout-grid">
      <div class="checkout-form">
        <h3>üìã Th√¥ng tin giao h√†ng</h3>
        <form id="checkoutForm">
          <div class="form-group">
            <label>H·ªç v√† t√™n <span style="color:red;">*</span></label>
            <input type="text" id="fullName" required placeholder="Nguy·ªÖn VƒÉn A">
          </div>

          <div class="form-group">
            <label>ƒê·ªãa ch·ªâ <span style="color:red;">*</span></label>
            <input type="text" id="address" required placeholder="123 ƒê∆∞·ªùng ABC, Qu·∫≠n 1, TP HCM">
          </div>

          <div class="form-group">
            <label>S·ªë ƒëi·ªán tho·∫°i <span style="color:red;">*</span></label>
            <input type="tel" id="phone" required placeholder="0988xxxxxx">
          </div>

          <div class="form-group">
            <label>Ghi ch√∫ (kh√¥ng b·∫Øt bu·ªôc)</label>
            <textarea id="note" rows="3" placeholder="Y√™u c·∫ßu ƒë·∫∑c bi·ªát, h∆∞·ªõng d·∫´n giao h√†ng..."></textarea>
          </div>

          <div style="margin-top: 24px;">
            <h3>üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
            <div class="payment-methods">
              <div class="payment-option">
                <input type="radio" id="cod" name="payment" value="cod" checked>
                <label for="cod">Thanh to√°n khi nh·∫≠n h√†ng (COD)</label>
              </div>
              <div class="payment-option">
                <input type="radio" id="bank" name="payment" value="bank">
                <label for="bank">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</label>
              </div>
              <div class="payment-option">
                <input type="radio" id="momo" name="payment" value="momo">
                <label for="momo">V√≠ Momo</label>
              </div>
            </div>
          </div>

          <div class="checkout-btn-group">
            <button id="placeOrderBtn" type="button">‚úì ƒê·∫∑t h√†ng</button>
          </div>
        </form>
      </div>

      <aside class="checkout-summary">
        <h3>üì¶ T√≥m t·∫Øt ƒë∆°n h√†ng</h3>
        <div id="summaryList">
          <p style="color: #999;">C√°c m√≥n ƒÉn v√† s·ªë l∆∞·ª£ng ƒë√£ ƒë·∫∑t ...</p>
        </div>
        <div class="checkout-total">
          <span class="checkout-total-label">T·ªïng c·ªông:</span>
          <span class="checkout-total-amount" id="summaryTotal">0 VND</span>
        </div>
      </aside>
    </section>
  </main>

  <div id="footer-placeholder"></div>

  <script src="../assets/js/include.js"></script>
  <script src="../assets/js/cart.js"></script>
  <script src="../assets/js/auth-guard.js"></script>
  <script src="../assets/js/order-history.js"></script>
  <script>
    // Y√™u c·∫ßu ƒëƒÉng nh·∫≠p ƒë·ªÉ checkout
    window.addEventListener('load', () => {
      if (!isLoggedIn()) window.location.href = './auth.html';
    });

    // Hi·ªÉn th·ªã t√≥m t·∫Øt gi·ªè h√†ng
    document.addEventListener('DOMContentLoaded', () => {
      const STORAGE_KEY = 'cart_items_v1'; //ƒë·ªçc d·ªØ li·ªáu t·ª´ gi·ªè hang
      const raw = localStorage.getItem(STORAGE_KEY) || '[]';
      let items = [];
      try { items = JSON.parse(raw); } catch(e) { items = []; }
      const list = document.getElementById('summaryList');
      const totalEl = document.getElementById('summaryTotal');
      const money = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', currencyDisplay: 'code' });
      let total = 0;
      if (!list) return;
      if (items.length === 0) list.innerHTML = '<div class="empty-cart-msg">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</div>';
      items.forEach(it => {
        total += (Number(it.price) || 0) * (it.qty || 1);
        const row = document.createElement('div');
        row.className = 'summary-item';
        row.innerHTML = `
          <span class="summary-item-name">${it.name}</span>
          <span class="summary-item-qty">x${it.qty}</span>
          <span class="summary-item-price">${money.format((Number(it.price)||0) * (it.qty||1))}</span>
        `;
        list.appendChild(row);
      });
      totalEl.textContent = money.format(total);

      document.getElementById('placeOrderBtn').addEventListener('click', () => {
        const fullname = document.getElementById('fullName').value.trim();
        const address = document.getElementById('address').value.trim();
        const phone = document.getElementById('phone').value.trim();
        if (!fullname || !address || !phone) { 
          alert('Vui l√≤ng ƒëi·ªÅn H·ªç t√™n, ƒê·ªãa ch·ªâ v√† S·ªë ƒëi·ªán tho·∫°i.'); 
          return; 
        }
        if (items.length === 0) {
          alert('Gi·ªè h√†ng ƒëang tr·ªëng. Vui l√≤ng th√™m s·∫£n ph·∫©m.');
          return;
        }
        // L∆∞u ƒë∆°n h√†ng v√†o localStorage (both old and new system for compatibility)
        const order = { 
          items, 
          fullname, 
          address, 
          phone, 
          note: document.getElementById('note').value || '', 
          payment: document.querySelector('input[name="payment"]:checked').value, 
          ts: Date.now(),
          id: 'ORD-' + Date.now(),
          status: 'pending'
        };
        // Save to old system (for backward compatibility)
        localStorage.setItem('last_order_demo', JSON.stringify(order));
        // Save to new system
        if (window.saveNewOrder) {
          window.saveNewOrder(order);
        } else {
          // Fallback if order-history.js not loaded
          const ORDERS_KEY = 'user_orders_v1';
          const allOrders = JSON.parse(localStorage.getItem(ORDERS_KEY) || '[]');
          allOrders.unshift(order);
          localStorage.setItem(ORDERS_KEY, JSON.stringify(allOrders));
        }
        localStorage.removeItem(STORAGE_KEY);
        alert('‚úì ƒê·∫∑t h√†ng th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng.\nXem l·ªãch s·ª≠ ƒë∆°n h√†ng trong t√†i kho·∫£n c·ªßa b·∫°n.');
        window.location.href = './homepage.html';
      });
    });
  </script>
</body>
</html>
